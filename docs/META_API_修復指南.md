# Meta API 廣告費問題修復指南

## 問題描述
近四天的 Meta 廣告費顯示為零元，但實際上有投放廣告。

## 修復內容

### ✅ 已完成的修復

1. **日期範圍自動調整**
   - 自動排除今天的數據（避免 Meta API 數據延遲）
   - 最多查詢到昨天的數據
   - 防止查詢未來日期

2. **改進的 JSON 格式**
   - 使用 `json.dumps()` 確保正確的 JSON 格式
   - 修復時間範圍參數的編碼問題

3. **增強的錯誤處理**
   - 詳細的 API 錯誤訊息顯示
   - 更好的異常捕獲和報告
   - 數據驗證和統計

4. **新增調試模式**
   - 可選的詳細調試信息
   - API 請求和響應的完整顯示
   - 逐日廣告費分析

5. **數據完整性檢查**
   - 自動統計零廣告費天數
   - 顯示總廣告費和平均值
   - 識別異常數據

## 使用方法

### 步驟 1：啟用調試模式
1. 打開 Streamlit Dashboard
2. 在左側面板找到「調試設定」
3. 勾選「啟用調試模式」

### 步驟 2：查看調試信息
調試模式會顯示：
- 查詢的帳號 ID
- 實際的日期範圍
- API 請求參數
- 原始數據樣本
- 每天的廣告費詳情

### 步驟 3：分析問題
檢查以下項目：

#### 🔍 API 連接
- 確認 Token 有效性
- 檢查帳號 ID 格式 (應包含 `act_` 前綴)
- 驗證 API 權限

#### 🔍 日期範圍
- 確認查詢的日期範圍正確
- 注意系統會自動調整到昨天
- 避免查詢太近期的數據

#### 🔍 廣告活動狀態
- 檢查該期間是否真的有投放廣告
- 確認廣告預算沒有用完
- 檢查廣告是否被暫停

## 常見問題與解決方案

### Q1: 為什麼近幾天的廣告費顯示為 $0？

**可能原因：**
1. **數據延遲**：Meta API 通常有 1-2 天的數據延遲
2. **廣告暫停**：廣告可能被系統暫停或預算用完
3. **權限問題**：API Token 缺少必要的讀取權限
4. **日期問題**：查詢了未來或當天的數據

**解決方案：**
1. 檢查日期範圍，避免查詢今天的數據
2. 登入 Meta 廣告管理員確認廣告狀態
3. 重新生成 API Token 並確保權限完整
4. 使用調試模式查看原始 API 響應

### Q2: API 返回錯誤訊息怎麼辦？

**常見錯誤代碼：**
- `190`: Token 無效或過期
- `100`: 權限不足
- `1`: 未知錯誤（通常是參數問題）

**解決方案：**
1. 檢查 Token 是否正確
2. 確認帳號 ID 格式
3. 重新獲取 Token 並檢查權限範圍
4. 使用 `meta_debug.py` 工具進行詳細診斷

### Q3: 如何驗證 Meta API 設定？

使用提供的調試工具：

```bash
cd "嗜酒食 Dashboard"
python meta_debug.py
```

在檔案中設定你的：
- `ACCESS_TOKEN`
- `ACCOUNT_ID`

工具會自動：
- 測試 API 連接
- 驗證帳號存取權限
- 分析廣告數據
- 識別問題原因

## 建議的檢查流程

1. **立即檢查**
   - 開啟調試模式
   - 查看是否有錯誤訊息
   - 檢查原始 API 響應

2. **數據驗證**
   - 對比 Meta 廣告管理員的數據
   - 檢查相同日期範圍的廣告費
   - 確認數據一致性

3. **權限檢查**
   - 使用 `meta_debug.py` 測試
   - 驗證 Token 權限
   - 確認帳號存取狀態

4. **日期調整**
   - 嘗試查詢更早的日期範圍
   - 避免查詢最近 1-2 天的數據
   - 使用系統建議的日期範圍

## 進階診斷

### 使用 Meta API Explorer
1. 訪問：https://developers.facebook.com/tools/explorer/
2. 使用相同的 Token 和參數
3. 手動測試 API 請求
4. 對比結果

### 檢查 Meta 廣告帳號
1. 登入 Meta 廣告管理員
2. 檢查帳號狀態和餘額
3. 確認廣告活動狀態
4. 查看相同期間的報表

## 聯繫支援

如果問題仍然存在：

1. **收集信息**
   - 調試模式的完整輸出
   - Meta 廣告管理員的截圖
   - 錯誤訊息的詳細內容

2. **檢查清單**
   - [ ] Token 有效且權限正確
   - [ ] 帳號 ID 格式正確
   - [ ] 該期間確實有廣告投放
   - [ ] 日期範圍合理（不包含今天）
   - [ ] API 請求參數正確

3. **備選方案**
   - 使用增強版 API (`meta_api_enhanced.py`)
   - 手動輸入已知的廣告費數據
   - 聯繫 Meta 開發者支援

---

## 更新記錄
- 2024-09-29: 創建修復指南
- 修復了日期範圍和 JSON 格式問題
- 新增調試模式和詳細錯誤處理
- 提供完整的診斷工具