# 🔑 Meta Token 自動管理指南

> 簡化版本：無需 OAuth，輸入短期 Token 即可自動轉換為長期 Token 並自動更新

## ✨ 新版特色

- ✅ **無需 OAuth 設定**：不需要複雜的 OAuth 回調設定
- ✅ **自動轉換**：輸入短期 Token，自動轉換為長期 Token（60 天）
- ✅ **自動更新**：Token 即將過期時自動刷新
- ✅ **持久化儲存**：Token 儲存在本地，重啟應用程式不需重新設定
- ✅ **簡單易用**：只需 3 個步驟即可完成設定

---

## 🚀 快速開始（3 步驟）

### 步驟 1：取得短期 Token

1. 前往 [Meta Graph API Explorer](https://developers.facebook.com/tools/explorer/)
2. 在右上角選擇你的應用程式（App ID: `2289820758095835`）
3. 在「權限」區塊勾選以下權限：
   - ✅ `ads_read`
   - ✅ `ads_management`（選填，如需管理廣告）
4. 點擊「產生存取權杖」按鈕
5. 複製產生的 Token

### 步驟 2：在應用程式中輸入 Token

1. 啟動 Flambé Dashboard：
   ```bash
   streamlit run app.py
   ```

2. 在側邊欄找到「🔑 Meta Token 管理」區塊

3. 貼上剛才複製的短期 Token

4. 點擊「🔄 轉換為長期 Token」

### 步驟 3：完成！

系統會自動：
- ✅ 將短期 Token 轉換為長期 Token（60 天有效期）
- ✅ 儲存到本地檔案 `.streamlit/meta_token.json`
- ✅ 顯示剩餘天數和建立日期
- ✅ Token 即將過期時自動更新

---

## 📊 UI 介面說明

### 初次設定時

```
┌─────────────────────────────────────────────┐
│ 🔑 Meta Token 管理                          │
│                                              │
│ ℹ️ 請輸入短期 Token，系統將自動轉換為       │
│    長期 Token（60 天有效期）                 │
│                                              │
│ 📝 如何取得短期 Token：                     │
│ 1. 前往 Meta Graph API Explorer            │
│ 2. 選擇你的應用程式                         │
│ 3. 在「權限」中勾選：ads_read、...          │
│ 4. 點擊「產生存取權杖」                     │
│ 5. 複製 Token 並貼到下方                    │
│                                              │
│ 短期 Access Token                           │
│ [                              ] 🔒         │
│                                              │
│ [🔄 轉換為長期 Token]                       │
└─────────────────────────────────────────────┘
```

### Token 設定完成後

```
┌─────────────────────────────────────────────┐
│ 🔑 Meta Token 管理                          │
│                                              │
│ ✅ Token 已設定且有效                       │
│                                              │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐    │
│ │剩餘天數  │ │建立日期  │ │          │    │
│ │  52 天   │ │2025-10-08│ │[🔄 手動  │    │
│ │          │ │          │ │  更新]   │    │
│ └──────────┘ └──────────┘ └──────────┘    │
│                                              │
│ ▼ 🔍 查看 Token 資訊                        │
│   Access Token                               │
│   [EAAh...] 🔒 (已隱藏)                     │
│   完整 Token: EAAh2H7...                    │
│   [🗑️ 刪除 Token]                           │
└─────────────────────────────────────────────┘
```

---

## 🔄 自動更新機制

### Token 生命週期

```
┌─ 取得 Token ────────────────────────────────┐
│ 第 0 天: 輸入短期 Token                      │
│         ↓                                    │
│         系統自動轉換為長期 Token             │
│         有效期：60 天                        │
└──────────────────────────────────────────────┘

┌─ 使用期間 ──────────────────────────────────┐
│ 第 1-53 天: 正常使用                         │
│            Token 完全有效                    │
│            無需任何操作                      │
└──────────────────────────────────────────────┘

┌─ 即將過期 ──────────────────────────────────┐
│ 第 54 天: 系統檢測到 Token 剩餘不到 7 天     │
│          ↓                                   │
│          🔄 自動刷新 Token                   │
│          ↓                                   │
│          ✅ 更新為新的 60 天 Token           │
│          ↓                                   │
│          顯示訊息：「Token 已自動更新！」     │
└──────────────────────────────────────────────┘
```

### 自動更新觸發條件

系統會在以下情況自動更新 Token：
- ⏰ Token 剩餘天數 < 7 天
- 🚀 應用程式啟動時檢查
- 📊 每次請求 Meta API 前檢查

---

## 🗂️ Token 儲存位置

Token 會儲存在以下位置：
```
flambe-dashboard/
└── .streamlit/
    └── meta_token.json
```

**檔案內容範例：**
```json
{
  "access_token": "EAAh2H7ZC...",
  "token_type": "bearer",
  "expires_in": 5183944,
  "expires_at": "2025-12-07T10:30:00.123456",
  "created_at": "2025-10-08T10:30:00.123456"
}
```

⚠️ **安全提醒：**
- 此檔案已加入 `.gitignore`，不會被提交到 Git
- 請勿分享此檔案內容
- 建議定期備份（可複製到安全位置）

---

## 🛠️ 手動操作

### 手動更新 Token

如果想手動刷新 Token（不等自動更新）：

1. 在「Token 管理」區塊點擊「🔄 手動更新 Token」
2. 系統會用當前 Token 換取新的 60 天 Token
3. 更新成功後顯示確認訊息

### 刪除 Token

如果需要重新設定：

1. 展開「🔍 查看 Token 資訊」
2. 點擊「🗑️ 刪除 Token」
3. 重新輸入短期 Token 進行設定

---

## 🔍 故障排除

### ❌ 轉換失敗：Token 無效

**可能原因：**
- Token 已過期（短期 Token 只有 1-2 小時有效期）
- Token 權限不足

**解決方案：**
1. 重新前往 Graph API Explorer
2. 確認已勾選 `ads_read` 權限
3. 重新產生 Token
4. 立即貼上並轉換（不要等太久）

### ❌ 自動更新失敗

**可能原因：**
- Token 已完全過期
- App ID 或 App Secret 設定錯誤

**解決方案：**
1. 查看錯誤訊息提示
2. 手動輸入新的短期 Token 重新設定
3. 確認 `.env` 中的 `META_APP_ID` 和 `META_APP_SECRET` 正確

### ⚠️ Token 儲存失敗

**可能原因：**
- `.streamlit/` 目錄權限問題
- 磁碟空間不足

**解決方案：**
```bash
# 手動建立目錄
mkdir -p .streamlit

# 檢查權限
ls -la .streamlit/
```

---

## 📝 常見問題

### Q1: 短期 Token 和長期 Token 有什麼差別？

| 類型 | 有效期 | 取得方式 | 用途 |
|------|--------|----------|------|
| **短期 Token** | 1-2 小時 | Graph API Explorer 手動產生 | 臨時測試、換取長期 Token |
| **長期 Token** | 60 天 | 由短期 Token 轉換而來 | 生產環境、長期使用 |

### Q2: 為什麼不直接用短期 Token？

短期 Token 只有 1-2 小時有效期，不適合生產環境。長期 Token 有 60 天有效期，並且可以自動刷新。

### Q3: Token 會不會永久有效？

不會。Meta 長期 Token 最長 60 天，但本系統會在即將過期時自動刷新，理論上可以無限期使用（只要 App 設定正確）。

### Q4: 我可以在多個環境使用同一個 Token 嗎？

可以，但不建議。建議每個環境（開發、測試、生產）使用獨立的 Token，方便管理和安全控制。

### Q5: 如何備份 Token？

複製 `.streamlit/meta_token.json` 檔案到安全位置。需要恢復時，將檔案放回原位即可。

---

## 🎯 最佳實踐

### ✅ 推薦做法

1. **定期檢查**：每週查看一次 Token 剩餘天數
2. **備份 Token**：定期備份 `meta_token.json`
3. **測試環境**：使用獨立的測試帳號和 Token
4. **監控日誌**：注意應用程式中的 Token 更新訊息

### ❌ 避免做法

1. ❌ 不要將 `meta_token.json` 提交到 Git
2. ❌ 不要在公開場合分享 Token
3. ❌ 不要忽略自動更新失敗的錯誤訊息
4. ❌ 不要在 Token 過期後才處理

---

## 📞 技術支援

如有問題，請：
1. 查看應用程式中的錯誤訊息
2. 參考本指南的「故障排除」章節
3. 透過 GitHub Issues 回報問題

---

**最後更新**：2025-10-08
**版本**：v3.0（簡化版 Token 管理）
**維護狀態**：✅ 活躍維護中
